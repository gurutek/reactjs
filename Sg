AWSTemplateFormatVersion: '2010-09-09'
Description: >
  CloudFormation template for creating security groups for Lambda, RDS, ElastiCache, and intermediary access

Parameters:
  VpcId:
    Type: String
    Description: 'The ID of the VPC where the security groups will be created'

  AppName:
    Type: String
    Description: 'The name of the application'
    Default: 'ShortLinkApp'

  Environment:
    Type: String
    Description: 'The deployment environment (dev, uat, prod)'
    AllowedValues: 
      - dev
      - uat
      - prod
    Default: 'dev'

Resources:
  LambdaSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: 'Security group for Lambda functions'
      VpcId: !Ref VpcId
      SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: 6379
          ToPort: 6379
          DestinationSecurityGroupId: !Ref ElastiCacheAccessGroup
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          DestinationSecurityGroupId: !Ref RdsAccessGroup
      Tags:
        - Key: appname
          Value: !Ref AppName
        - Key: environment
          Value: !Ref Environment

  ElastiCacheSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: 'Security group for ElastiCache Redis'
      VpcId: !Ref VpcId
      Tags:
        - Key: appname
          Value: !Ref AppName
        - Key: environment
          Value: !Ref Environment

  RdsSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: 'Security group for RDS'
      VpcId: !Ref VpcId
      Tags:
        - Key: appname
          Value: !Ref AppName
        - Key: environment
          Value: !Ref Environment

  ElastiCacheAccessGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: 'Security group for ElastiCache access from Lambda'
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 6379
          ToPort: 6379
          SourceSecurityGroupId: !Ref LambdaSecurityGroup
      Tags:
        - Key: appname
          Value: !Ref AppName
        - Key: environment
          Value: !Ref Environment

  RdsAccessGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: 'Security group for RDS access from Lambda'
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          SourceSecurityGroupId: !Ref LambdaSecurityGroup
      Tags:
        - Key: appname
          Value: !Ref AppName
        - Key: environment
          Value: !Ref Environment

  ApiGatewaySecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: 'Security group for API Gateway'
      VpcId: !Ref VpcId
      Tags:
        - Key: appname
          Value: !Ref AppName
        - Key: environment
          Value: !Ref Environment

Outputs:
  LambdaSecurityGroupId:
    Description: "ID of the Lambda security group"
    Value: !Ref LambdaSecurityGroup
    Export:
      Name: !Sub "${AWS::StackName}-LambdaSecurityGroupId"

  ElastiCacheSecurityGroupId:
    Description: "ID of the ElastiCache security group"
    Value: !Ref ElastiCacheSecurityGroup
    Export:
      Name: !Sub "${AWS::StackName}-ElastiCacheSecurityGroupId"

  RdsSecurityGroupId:
    Description: "ID of the RDS security group"
    Value: !Ref RdsSecurityGroup
    Export:
      Name: !Sub "${AWS::StackName}-RdsSecurityGroupId"

  ElastiCacheAccessGroupId:
    Description: "ID of the ElastiCache access security group"
    Value: !Ref ElastiCacheAccessGroup
    Export:
      Name: !Sub "${AWS::StackName}-ElastiCacheAccessGroupId"

  RdsAccessGroupId:
    Description: "ID of the RDS access security group"
    Value: !Ref RdsAccessGroup
    Export:
      Name: !Sub "${AWS::StackName}-RdsAccessGroupId"

  ApiGatewaySecurityGroupId:
    Description: "ID of the API Gateway security group"
    Value: !Ref ApiGatewaySecurityGroup
    Export:
      Name: !Sub "${AWS::StackName}-ApiGatewaySecurityGroupId"
