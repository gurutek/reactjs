AWSTemplateFormatVersion: '2010-09-09'
Description: Security groups for Lambda, RDS PostgreSQL, ElastiCache, and API Gateway

Parameters:
  VpcId:
    Type: AWS::EC2::VPC::Id
    Description: The ID of the existing VPC

  AllowedIP:
    Type: String
    Description: The IP address allowed to access RDS and Redis
    Default: "203.0.113.0/24" # Change this to your specific IP address or CIDR block

  AppName:
    Type: String
    Description: The name of the application
    Default: "MyApp"

  Environment:
    Type: String
    Description: The environment (e.g., dev, uat, prod)
    Default: "dev"

  UserId:
    Type: String
    Description: The user ID
    Default: "user123"

  Role:
    Type: String
    Description: The role
    Default: "developer"

Resources:
  LambdaSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Lambda functions
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          SourceSecurityGroupId: !Ref RdsSecurityGroup
        - IpProtocol: tcp
          FromPort: 6379
          ToPort: 6379
          SourceSecurityGroupId: !Ref ElastiCacheSecurityGroup
      Tags:
        - Key: appname
          Value: !Ref AppName
        - Key: environment
          Value: !Ref Environment
        - Key: userid
          Value: !Ref UserId
        - Key: role
          Value: !Ref Role

  RdsSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for RDS PostgreSQL
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          SourceSecurityGroupId: !Ref LambdaSecurityGroup
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          CidrIp: !Ref AllowedIP
      Tags:
        - Key: appname
          Value: !Ref AppName
        - Key: environment
          Value: !Ref Environment
        - Key: userid
          Value: !Ref UserId
        - Key: role
          Value: !Ref Role

  ElastiCacheSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for ElastiCache
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 6379
          ToPort: 6379
          SourceSecurityGroupId: !Ref LambdaSecurityGroup
        - IpProtocol: tcp
          FromPort: 6379
          ToPort: 6379
          CidrIp: !Ref AllowedIP
      Tags:
        - Key: appname
          Value: !Ref AppName
        - Key: environment
          Value: !Ref Environment
        - Key: userid
          Value: !Ref UserId
        - Key: role
          Value: !Ref Role

  ApiGatewaySecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for API Gateway
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: appname
          Value: !Ref AppName
        - Key: environment
          Value: !Ref Environment
        - Key: userid
          Value: !Ref UserId
        - Key: role
          Value: !Ref Role

Outputs:
  LambdaSecurityGroupId:
    Description: Security Group ID for Lambda
    Value: !Ref LambdaSecurityGroup

  RdsSecurityGroupId:
    Description: Security Group ID for RDS
    Value: !Ref RdsSecurityGroup

  ElastiCacheSecurityGroupId:
    Description: Security Group ID for ElastiCache
    Value: !Ref ElastiCacheSecurityGroup

  ApiGatewaySecurityGroupId:
    Description: Security Group ID for API Gateway
    Value: !Ref ApiGatewaySecurityGroup
