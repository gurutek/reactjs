AWSTemplateFormatVersion: '2010-09-09'
Description: CloudFormation template to create an RDS PostgreSQL cluster with two instances in the us-east-1a availability zone.

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: "Database Settings"
        Parameters:
          - VpcId
          - SubnetIds
          - DBClusterIdentifier
          - DBName
          - MasterUsername
          - MasterUserPassword
          - DBInstanceClass
          - EngineVersion
          - DBClusterSecurityGroupId
          - Environment
          - AppName
    ParameterLabels:
      VpcId:
        default: "VPC ID"
      SubnetIds:
        default: "Subnet IDs"
      DBClusterIdentifier:
        default: "Database Cluster Identifier"
      DBName:
        default: "Database Name"
      MasterUsername:
        default: "Master Username"
      MasterUserPassword:
        default: "Master User Password"
      DBInstanceClass:
        default: "Instance Class"
      EngineVersion:
        default: "Engine Version"
      DBClusterSecurityGroupId:
        default: "DB Cluster Security Group ID"
      Environment:
        default: "Environment"
      AppName:
        default: "Application Name"

Parameters:
  VpcId:
    Type: AWS::EC2::VPC::Id
    Description: The ID of the existing VPC where the RDS cluster will be deployed.

  SubnetIds:
    Type: List<AWS::EC2::Subnet::Id>
    Description: The IDs of the subnets in the us-east-1a availability zone.

  DBClusterIdentifier:
    Type: String
    Description: The identifier for the RDS cluster.

  DBName:
    Type: String
    Description: The name of the database to create.

  MasterUsername:
    Type: String
    Description: The master username for the database.

  MasterUserPassword:
    Type: String
    NoEcho: true
    Description: The master user password for the database.

  DBInstanceClass:
    Type: String
    Default: db.t3.large
    Description: The compute and memory capacity of the DB instances in the cluster (e.g., db.t3.large).

  EngineVersion:
    Type: String
    Default: 13.3
    Description: The PostgreSQL engine version.

  DBClusterSecurityGroupId:
    Type: AWS::EC2::SecurityGroup::Id
    Description: The ID of the security group for the RDS cluster.

  Environment:
    Type: String
    Description: The environment where the resources are deployed (e.g., dev, uat, prod).
    Default: dev

  AppName:
    Type: String
    Description: The name of your application.
    Default: ShortLinkResolver

Mappings:
  AWSRegionToAMI:
    us-east-1:
      HVM64: ami-0ff8a91507f77f867

Resources:
  DBCluster:
    Type: AWS::RDS::DBCluster
    Properties:
      DBClusterIdentifier: !Ref DBClusterIdentifier
      Engine: aurora-postgresql
      EngineVersion: !Ref EngineVersion
      MasterUsername: !Ref MasterUsername
      MasterUserPassword: !Ref MasterUserPassword
      DatabaseName: !Ref DBName
      VpcSecurityGroupIds:
        - !Ref DBClusterSecurityGroupId
      DBSubnetGroupName: !Ref DBSubnetGroup
      Tags:
        - Key: appname
          Value: !Ref AppName
        - Key: environment
          Value: !Ref Environment
    DeletionPolicy: Snapshot
    UpdateReplacePolicy: Snapshot

  DBInstance1:
    Type: AWS::RDS::DBInstance
    Properties:
      DBClusterIdentifier: !Ref DBCluster
      DBInstanceClass: !Ref DBInstanceClass
      Engine: aurora-postgresql
      PubliclyAccessible: false
      Tags:
        - Key: appname
          Value: !Ref AppName
        - Key: environment
          Value: !Ref Environment
    DeletionPolicy: Snapshot
    UpdateReplacePolicy: Snapshot

  DBInstance2:
    Type: AWS::RDS::DBInstance
    Properties:
      DBClusterIdentifier: !Ref DBCluster
      DBInstanceClass: !Ref DBInstanceClass
      Engine: aurora-postgresql
      PubliclyAccessible: false
      Tags:
        - Key: appname
          Value: !Ref AppName
        - Key: environment
          Value: !Ref Environment
    DeletionPolicy: Snapshot
    UpdateReplacePolicy: Snapshot

  DBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: Subnet group for RDS cluster
      SubnetIds: !Ref SubnetIds
      DBSubnetGroupName: !Sub "${AppName}-db-subnet-group"
      Tags:
        - Key: appname
          Value: !Ref AppName
        - Key: environment
          Value: !Ref Environment

Outputs:
  DBClusterIdentifierOutput:
    Description: The identifier of the RDS cluster
    Value: !Ref DBCluster
    Export:
      Name: !Sub "${AWS::StackName}-DBClusterIdentifier"

  DBClusterEndpoint:
    Description: The endpoint address of the RDS cluster
    Value: !GetAtt DBCluster.Endpoint.Address
    Export:
      Name: !Sub "${AWS::StackName}-DBClusterEndpoint"

  DBClusterPort:
    Description: The port number of the RDS cluster
    Value: !GetAtt DBCluster.Endpoint.Port
    Export:
      Name: !Sub "${AWS::StackName}-DBClusterPort"

  DBSubnetGroupNameOutput:
    Description: The name of the DB subnet group
    Value: !Ref DBSubnetGroup
    Export:
      Name: !Sub "${AWS::StackName}-DBSubnetGroupName"
