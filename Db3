AWSTemplateFormatVersion: '2010-09-09'
Description: CloudFormation template to create a single instance PostgreSQL database with 50 GB of storage in the us-east-1a availability zone.

# Metadata helps organize parameters into logical groups and provide labels for better readability in the CloudFormation console.
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: "Database Settings"
        Parameters:
          - VpcId # VPC ID where the RDS instance will be deployed
          - SubnetId # Subnet ID where the RDS instance will be placed
          - DBInstanceIdentifier # Identifier for the RDS instance
          - DBName # Name of the database to be created
          - MasterUsername # Master username for the database
          - MasterUserPassword # Master password for the database
          - DBInstanceClass # Instance type for the RDS instance
          - EngineVersion # PostgreSQL engine version
          - DBSecurityGroupId # Security group ID for the RDS instance
          - Environment # Deployment environment (e.g., dev, uat, prod)
          - AppName # Application name
    ParameterLabels:
      VpcId:
        default: "VPC ID"
      SubnetId:
        default: "Subnet ID"
      DBInstanceIdentifier:
        default: "Database Instance Identifier"
      DBName:
        default: "Database Name"
      MasterUsername:
        default: "Master Username"
      MasterUserPassword:
        default: "Master User Password"
      DBInstanceClass:
        default: "Instance Class"
      EngineVersion:
        default: "Engine Version"
      DBSecurityGroupId:
        default: "DB Security Group ID"
      Environment:
        default: "Environment"
      AppName:
        default: "Application Name"

# Parameters are input values needed to create the stack. These values can be provided by the user when launching the stack.
Parameters:
  VpcId:
    Type: AWS::EC2::VPC::Id
    Description: The ID of the existing VPC where the RDS instance will be deployed.

  SubnetId:
    Type: AWS::EC2::Subnet::Id
    Description: The ID of the subnet in the us-east-1a availability zone.

  DBInstanceIdentifier:
    Type: String
    Description: The identifier for the RDS instance.

  DBName:
    Type: String
    Description: The name of the database to create.

  MasterUsername:
    Type: String
    Description: The master username for the database.

  MasterUserPassword:
    Type: String
    NoEcho: true
    Description: The master user password for the database.

  DBInstanceClass:
    Type: String
    Default: db.t3.large
    Description: The compute and memory capacity of the DB instance (e.g., db.t3.large).

  EngineVersion:
    Type: String
    Default: 13.3
    Description: The PostgreSQL engine version.

  DBSecurityGroupId:
    Type: AWS::EC2::SecurityGroup::Id
    Description: The ID of the security group for the RDS instance.

  Environment:
    Type: String
    Description: The environment where the resources are deployed (e.g., dev, uat, prod).
    Default: dev

  AppName:
    Type: String
    Description: The name of your application.
    Default: ShortLinkResolver

# Mappings section provides a way to map keys to corresponding values. (Included for completeness)
Mappings:
  AWSRegionToAMI:
    us-east-1:
      HVM64: ami-0ff8a91507f77f867

# Resources are the AWS services and their properties that CloudFormation will create and configure.
Resources:
  # DBInstance creates a single PostgreSQL RDS instance.
  DBInstance:
    Type: AWS::RDS::DBInstance
    Properties:
      DBInstanceIdentifier: !Ref DBInstanceIdentifier # Unique identifier for the RDS instance
      DBName: !Ref DBName # Name of the database to create
      MasterUsername: !Ref MasterUsername # Master username for the database
      MasterUserPassword: !Ref MasterUserPassword # Master user password for the database
      DBInstanceClass: !Ref DBInstanceClass # Compute and memory capacity of the DB instance
      AllocatedStorage: 50 # Amount of storage (in GB) allocated to the database
      Engine: postgres # Database engine type (PostgreSQL)
      EngineVersion: !Ref EngineVersion # Version of the PostgreSQL engine
      VPCSecurityGroups:
        - !Ref DBSecurityGroupId # Security group ID for the RDS instance
      AvailabilityZone: us-east-1a # Availability zone where the RDS instance will be deployed
      MultiAZ: false # Indicates whether to create a standby instance in another availability zone (disabled)
      StorageType: gp2 # Type of storage (General Purpose SSD)
      StorageEncrypted: true # Whether the storage is encrypted
      BackupRetentionPeriod: 7 # Number of days to retain automated backups
      PreferredBackupWindow: 03:00-04:00 # Preferred time window for daily backups
      PreferredMaintenanceWindow: sun:04:00-sun:05:00 # Preferred time window for maintenance
      DBSubnetGroupName: !Ref DBSubnetGroup # Subnet group for the RDS instance
      PubliclyAccessible: false # Whether the database instance is publicly accessible
      Tags:
        - Key: appname
          Value: !Ref AppName
        - Key: environment
          Value: !Ref Environment
    DeletionPolicy: Snapshot # Policy to create a snapshot of the DB instance before deleting it
    UpdateReplacePolicy: Snapshot # Policy to create a snapshot before replacing the DB instance during updates

  # DBSubnetGroup specifies the subnet where the RDS instance will be deployed.
  DBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: Subnet group for RDS instance
      SubnetIds: [!Ref SubnetId] # List of subnet IDs for the DB subnet group
      DBSubnetGroupName: !Sub "${AppName}-db-subnet-group" # Name of the DB subnet group
      Tags:
        - Key: appname
          Value: !Ref AppName
        - Key: environment
          Value: !Ref Environment

# Outputs section provides the values that will be returned when the stack is created, such as identifiers and endpoints.
Outputs:
  DBInstanceIdentifierOutput:
    Description: The identifier of the RDS instance
    Value: !Ref DBInstance
    Export:
      Name: !Sub "${AWS::StackName}-DBInstanceIdentifier"

  DBInstanceEndpoint:
    Description: The endpoint address of the RDS instance
    Value: !GetAtt DBInstance.Endpoint.Address
    Export:
      Name: !Sub "${AWS::StackName}-DBInstanceEndpoint"

  DBInstancePort:
    Description: The port number of the RDS instance
    Value: !GetAtt DBInstance.Endpoint.Port
    Export:
      Name: !Sub "${AWS::StackName}-DBInstancePort"

  DBSubnetGroupNameOutput:
    Description: The name of the DB subnet group
    Value: !Ref DBSubnetGroup
    Export:
      Name: !Sub "${AWS::StackName}-DBSubnetGroupName"
