AWSTemplateFormatVersion: '2010-09-09'
Transform: 'AWS::Serverless-2016-10-31'
Description: SAM Template for Aurora PostgreSQL Database

Globals:
  DBCluster:
    Engine: aurora-postgresql

Resources:
  # Aurora PostgreSQL DB Cluster
  AuroraDBCluster:
    Type: AWS::RDS::DBCluster
    Properties:
      MasterUsername: !Ref DBUsername
      MasterUserPassword: !Ref DBPassword
      DBSubnetGroupName: !Ref AuroraDBSubnetGroup
      VpcSecurityGroupIds:
        - !Ref DBClusterSecurityGroup

  AuroraDBInstance:
    Type: AWS::RDS::DBInstance
    Properties:
      DBClusterIdentifier: !Ref AuroraDBCluster
      DBInstanceClass: db.t3.large
      Engine: aurora-postgresql

  AuroraDBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: "Subnet group for Aurora DB cluster"
      SubnetIds: !Ref SubnetIds

  DBClusterSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow access to Aurora DB
      VpcId: !Ref VPCId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          SourceSecurityGroupId: !Ref LambdaSecurityGroup  # Allow Lambda to access the DB

  RedisSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow access to Redis
      VpcId: !Ref VPCId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 6379
          ToPort: 6379
          SourceSecurityGroupId: !Ref LambdaSecurityGroup  # Allow Lambda to access Redis

Outputs:
  AuroraDBClusterEndpoint:
    Description: "The endpoint of the Aurora DB cluster"
    Value: !GetAtt AuroraDBCluster.Endpoint.Address

  AuroraDBClusterPort:
    Description: "The port of the Aurora DB cluster"
    Value: '5432'
